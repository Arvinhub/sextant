# `bsroot`

The *bootstrapper* Docker image contains services including dnsmasq,
cloud-config-server, and Docker registry.  The general idea about
*bsroot* is that we put most data files and configuration files for
these services in a directory on the host, and this directory will be
mounted into the bootstrapper container as `/bsroot`.

## Directory Structure

- `/bsroot/dnsmasq.conf`: The dnsmasq config file.  It is supposed to
  be generated by the `github.com/k8sp/auto-install/bootstrapper`
  program from translating a `cluster-desc.yml` file that describes
  the Kubernetes
  cluster. [TODO(yi): We need a link here to explain more about `cluster-desc.yml`.]

- `/bsroot/registry.yml`: The Docker registry config file.  It is
  supposed to be generated by the
  `github.com/k8sp/auto-install/bootstrapper` program.

- `/bsroot/registry/`: The directory mounted to bootstrapper container
  as registry volume.  It is created by the Docker registry service
  running inside the bootstrapper container.  This directory is
  mentioned in `/bsroot/registry.yml`.

## Build and Run

The real bootstrapper image will contain several services, just in the
current early stage I write a Dockerfile as an example that describes
only one service, the Docker registry.  To build a Docker image from
this Dockerfile:

```
docker build -t registry -f registry.Dockerfile .
```

To run the bootstrapper as a Docker container named `registry`:
```
docker run -d --privileged -p 5000:5000 --name registry -v $(pwd)/bsroot:/bsroot registry
```

Then we should be able to push an image into it:
```
docker tag hello-world localhost:5000/hello
docker push localhost:5000/hello
```

## Troubleshooting

1. If `docker push` retries as following

   ```
   bootstrapper$ docker push localhost:5000/hello
   The push refers to a repository [localhost:5000/hello]
   a02596fdd012: Retrying in 5 seconds
   ```

   it is very likely that the Docker container doesn't have write
   permission to `/bsroot/registry`.  A simple solution is to manually
   create it and grants everyone to access it:

   ```
   bootstrapper$ mkdir /bsroot/registry
   bootstrapper$ chmod a+rwx /bsroot/registry
   ```

1. If `docker run -d ... registry` fails with no output, please replace `-d` by `--rm -it`:

   ```
   docker run --rm -it --privileged -p 5000:5000 --name registry -v $(pwd)/bsroot:/bsroot registry
   ```

   This would allow `docker run` to copy the output from `registry` to the terminal.
